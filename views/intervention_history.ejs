<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Historique de la tâche</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body class="app-body">
    <header class="app-header">
      <h1>Historique de la tâche</h1>
    </header>

    <main class="page-shell">
    <% const formatDateFr = date => {
         if (!date) return '';
         const d = new Date(date);
         const day = String(d.getDate()).padStart(2, '0');
         const month = String(d.getMonth() + 1).padStart(2, '0');
         const year = d.getFullYear();
         return `${day}-${month}-${year}`;
       }; %>
    <section class="card">
  <p>
    Chantier : <strong><%= intervention.chantier_name %></strong><br/>
    Étape : <%= intervention.floor_name || intervention.old_floor_name || '-' %> - 
    Pièce : <%= intervention.room_name || intervention.old_room_name || '-' %><br/>
    Lot : <%= intervention.lot %><br/>
    Tâche : <%= intervention.task %><br/>
    Créée le :
    <% if (intervention.created_at) { %>
      <%= formatDateFr(intervention.created_at) %>
    <% } else { %>
      -
    <% } %>
  </p>

  <% if (history && history.length) {
       const last = history[history.length - 1];
       const lastDate = formatDateFr(last.created_at);
       const lastType =
         last.event_type === 'creation' ? 'Création' :
         last.event_type === 'status_change' ? 'Changement de statut' :
         last.event_type === 'edit' ? 'Modification' :
         last.event_type;
  %>
    <div class="last-action-banner">
      Dernière action :
      <strong><%= lastType %></strong>
      le <strong><%= lastDate %></strong>
      par <strong><%= last.actor_name || last.actor_email || '—' %></strong>
    </div>
  <% } %>

  <a href="/chantiers/<%= intervention.chantier_id %>/taches" class="btn btn-secondary">
    ← Retour aux tâches
  </a>
</section>


      <section class="card">
        <h2>Historique des actions</h2>

        <table class="table">
          <thead>
            <tr>
              <th>Date enregistrement</th>
              <th>Type</th>
              <th>Ancien statut</th>
              <th>Nouveau statut</th>
              <th>Personnes</th>
              <th>Date de l'action</th>
              <th>Acteur</th>
              <th>Détail</th>
            </tr>
          </thead>
          <tbody>
            <% if (!history.length) { %>
              <tr>
                <td colspan="8" class="empty-state">
                  Aucun historique pour cette tâche.
                </td>
              </tr>
            <% } %>

            <% history.forEach(h => { %>
              <%
                const createdFr  = formatDateFr(h.created_at);
                const eventFr    = formatDateFr(h.date_event);
              %>
              <tr class="<%= h.event_type === 'edit' ? 'history-row-edit' : '' %>">
                <td><%= createdFr %></td>
                <td><%= h.event_type %></td>
                <td><%= h.old_status || '' %></td>
                <td><%= h.new_status || '' %></td>
                <td><%= h.persons || '' %></td>
                <td><%= eventFr %></td>
                <td>
                  <div><strong><%= h.actor_name || '' %></strong></div>
                  <div><small><%= h.actor_email || '' %></small></div>
                </td>
                <td class="history-detail-cell">
                  <% if (h.event_type === 'edit') { %>
                    <% 
                      const note = (h.note || '').replace(/^Modification de la tâche\s*:\s*/i, '');
                      const parts = note.split('|').map(p => p.trim()).filter(Boolean);
                    %>
                    <ul class="history-changes">
                      <% parts.forEach(p => { 
                           const arrowIndex = p.indexOf('→');
                      %>
                        <li>
                          <% if (arrowIndex !== -1) { 
                               const before = p.slice(0, arrowIndex).trim();
                               const after  = p.slice(arrowIndex + 1).trim();
                          %>
                            <span class="change-before"><%= before %> →</span>
                            <span class="change-after"><%= ' ' + after %></span>
                          <% } else { %>
                            <span><%= p %></span>
                          <% } %>
                        </li>
                      <% }) %>
                    </ul>
                  <% } else { %>
                    <%= h.note || '' %>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </section>
    </main>
  </body>
</html>
