<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Suivi des tâches - <%= chantier.display_name %></title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body class="app-body">
    <header class="app-header">
      <h1>Suivi des tâches - <%= chantier.display_name %></h1>
      <div class="user-info">
        Connecté en tant que
        <strong><%= currentUser.prenom %> <%= currentUser.nom %></strong>
        (<%= currentUser.email %>)
        <a href="/logout">Déconnexion</a>
      </div>
    </header>

    <main class="page-shell">
      <section class="card">
        <div class="section-heading with-actions">
          <a href="/" class="btn btn-secondary">← Retour aux chantiers</a>
          <h2>Filtres</h2>
        </div>
        <form method="get" class="filters filter-grid">
          <label>Étage
            <select name="floor">
              <option value="">Tous</option>
              <% floors.forEach(f => { %>
                <option value="<%= f.id %>" <%= String(filters.floor) === String(f.id) ? 'selected' : '' %>><%= f.name %></option>
              <% }) %>
            </select>
          </label>

          <label>Pièce
            <select name="room">
              <option value="">Toutes</option>
              <% rooms.forEach(r => { %>
                <option value="<%= r.id %>" <%= String(filters.room) === String(r.id) ? 'selected' : '' %>><%= r.floor_name %> - <%= r.name %></option>
              <% }) %>
            </select>
          </label>

          <label>Lot
            <select name="lot">
              <option value="">Tous</option>
              <% lotsOptions.forEach(l => { %>
                <option value="<%= l.lot %>" <%= filters.lot === l.lot ? 'selected' : '' %>>
                  <%= l.lot %>
                </option>
              <% }) %>
            </select>
          </label>

          <label>Statut
            <select name="status">
              <option value="">Tous</option>
              <option value="a faire" <%= filters.status === 'a faire' ? 'selected' : '' %>>A faire</option>
              <option value="en cours" <%= filters.status === 'en cours' ? 'selected' : '' %>>En cours</option>
              <option value="terminé" <%= filters.status === 'terminé' ? 'selected' : '' %>>Terminé</option>
            </select>
          </label>

          <div class="filters-actions">
            <button type="submit" class="btn">Filtrer</button>
            <a href="/chantiers/<%= chantier.id %>/taches" class="btn btn-secondary">Réinitialiser</a>
          </div>
        </form>
      </section>

      <section class="card">
        <div class="section-heading">
          <h2>Liste des tâches (interventions)</h2>
        </div>
        <table class="table">
          <thead>
            <tr>
              <th>Étage</th>
              <th>Pièce</th>
              <th>Lot</th>
              <th>Tâche</th>
              <th>Statut</th>
              <th>Qui / Quand</th>
              <th>Créée le</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% if (!interventions.length) { %>
              <tr>
                <td colspan="8" class="empty-state">Aucune intervention pour ce chantier (ou filtre trop restrictif).</td>
              </tr>
            <% } %>
            <% interventions.forEach(i => { const statusClass = i.status === 'terminé' ? 'status-termine' : i.status === 'en cours' ? 'status-en-cours' : 'status-a-faire'; %>
              <tr class="<%= i.status === 'terminé' ? 'done' : '' %>">
                <td><%= i.floor_name || i.old_floor_name %></td>
                <td><%= i.room_name || i.old_room_name %></td>
                <td><%= i.lot %></td>
                <td><%= i.task %></td>
                <td><span class="status-badge <%= statusClass %>"><%= i.status %></span></td>
                <td>
                  <strong><%= i.person || '' %></strong><br />
                  <small class="action-text"><%= i.action || '' %></small>
                </td>

                <td><%= i.created_at ? i.created_at.toISOString().slice(0,10) : '' %></td>
                <td class="table-actions">
                  <a href="/interventions/<%= i.id %>/history"
                     class="btn btn-small btn-secondary"
                     target="_blank">
                    Info
                  </a>

                  <% if (i.status !== 'terminé') { %>
                    <form method="post" action="/interventions/<%= i.id %>/status" class="status-form">
                      <input type="hidden" name="new_status" value="en cours" />
                  <label>Qui ?
                    <div class="multi-dropdown" data-multi-dropdown>
                      <button type="button" class="multi-dropdown-toggle">
                        Sélectionner...
                      </button>
                      <div class="multi-dropdown-panel">
                        <% usersList.forEach(u => { 
                             const label = (u.prenom + ' ' + u.nom).trim() || u.email;
                        %>
                          <label class="multi-dropdown-option">
                            <input type="checkbox" name="persons" value="<%= label %>">
                            <span><%= label %></span>
                          </label>
                        <% }) %>
                      </div>
                    </div>
                  </label>

                      <label>Depuis quand ?
                        <input type="date" name="date" value="<%= new Date().toISOString().slice(0,10) %>" />
                      </label>
                      <button type="submit" class="btn btn-small">En cours</button>
                    </form>
                  <% } %>

                  <% if (i.status !== 'terminé') { %>
                    <form method="post" action="/interventions/<%= i.id %>/status" class="status-form">
                      <input type="hidden" name="new_status" value="terminé" />
                      <label>Qui ?
                          <div class="multi-dropdown" data-multi-dropdown>
                            <button type="button" class="multi-dropdown-toggle">
                              Sélectionner...
                            </button>
                            <div class="multi-dropdown-panel">
                              <% usersList.forEach(u => { 
                                   const label = (u.prenom + ' ' + u.nom).trim() || u.email;
                              %>
                                <label class="multi-dropdown-option">
                                  <input type="checkbox" name="persons" value="<%= label %>">
                                  <span><%= label %></span>
                                </label>
                              <% }) %>
                            </div>
                          </div>
                        </label>

                      <label>Quand ?
                        <input type="date" name="date" value="<%= new Date().toISOString().slice(0,10) %>" />
                      </label>
                      <button type="submit" class="btn btn-small">Terminer</button>
                    </form>
                  <% } %>

                  <% if (i.status !== 'a faire') { %>
                    <form method="post" action="/interventions/<%= i.id %>/status" class="status-form">
                      <input type="hidden" name="new_status" value="a faire" />
                      <label>Date
                        <input type="date" name="date" value="<%= new Date().toISOString().slice(0,10) %>" />
                      </label>
                      <button type="submit" class="btn btn-small btn-secondary">Remettre à faire</button>
                    </form>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </section>

      <section class="card">
        <div class="section-heading with-actions">
          <h2>Ajouter une ou plusieurs interventions</h2>
          <a href="/chantiers/<%= chantier.id %>/lots" class="btn btn-secondary">Appliquer des LOTs du catalogue</a>
        </div>

        <form method="post" action="/chantiers/<%= chantier.id %>/interventions" class="add-task-form">
          <label>Étage
            <select name="floor_id" required>
              <% floors.forEach(f => { %>
                <option value="<%= f.id %>"><%= f.name %></option>
              <% }) %>
            </select>
          </label>

       <label>Pièces (choix multiple)
  <div class="multi-dropdown" data-multi-dropdown data-rooms-dropdown>
    <button type="button" class="multi-dropdown-toggle">
      Sélectionner les pièces...
    </button>
    <div class="multi-dropdown-panel">
      <% rooms.forEach(r => { %>
        <label class="multi-dropdown-option" data-room-floor="<%= r.floor_id %>">
          <input type="checkbox" name="room_ids" value="<%= r.id %>">
          <span><%= r.floor_name %> - <%= r.name %></span>
        </label>
      <% }) %>
    </div>
  </div>
  <span class="help">Choix multiple possible.</span>
</label>


          <label>Lot
            <select name="lot" required>
              <option value="">-- Choisir un LOT --</option>

              <% if (typeof catalogueLots !== 'undefined' && catalogueLots && catalogueLots.length) { %>
                <% catalogueLots.forEach(l => { %>
                  <option value="<%= l.lot %>"><%= l.lot %></option>
                <% }) %>
              <% } else { %>
                <% lotsOptions.forEach(l => { %>
                  <option value="<%= l.lot %>"><%= l.lot %></option>
                <% }) %>
              <% } %>
            </select>
          </label>

          <label>Tâche
            <select name="task" required>
              <option value="">-- Choisir un LOT d'abord --</option>
            </select>
          </label>

          <button type="submit" class="btn">Créer</button>
        </form>
      </section>
    </main>

<script>
  // données LOT / Tâche envoyées par le serveur
  const LOT_TASKS = <%- JSON.stringify(lotTasks || []) %>;
</script>

<script>
  // données des pièces (à réutiliser dans plusieurs scripts)
  const ROOMS_DATA = JSON.parse('<%- JSON.stringify(rooms || []) %>');
</script>

<script>
  (function () {
    // données envoyées par le serveur (voir script LOT_TASKS plus haut)
    const lotTasks = Array.isArray(LOT_TASKS) ? LOT_TASKS : [];

    // construire map lot -> [tâches]
    const tasksByLot = {};
    lotTasks.forEach(row => {
      if (!row.lot || !row.task) return;
      if (!tasksByLot[row.lot]) tasksByLot[row.lot] = [];
      if (!tasksByLot[row.lot].includes(row.task)) {
        tasksByLot[row.lot].push(row.task);
      }
    });

    const form = document.querySelector('form.add-task-form');
    if (!form) return;

    const lotSelect  = form.querySelector('select[name="lot"]');
    const taskSelect = form.querySelector('select[name="task"]');

    if (!lotSelect || !taskSelect) return;

    function refreshTasks() {
      const lot = lotSelect.value;

      // vider la liste
      while (taskSelect.firstChild) {
        taskSelect.removeChild(taskSelect.firstChild);
      }

      const defaultOpt = document.createElement('option');
      defaultOpt.value = '';
      if (!lot) {
        defaultOpt.textContent = "-- Choisir un LOT d'abord --";
        taskSelect.appendChild(defaultOpt);
        return;
      }

      if (!tasksByLot[lot] || !tasksByLot[lot].length) {
        defaultOpt.textContent = "Aucune tâche définie pour ce LOT";
        taskSelect.appendChild(defaultOpt);
        return;
      }

      defaultOpt.textContent = "-- Choisir une tâche --";
      taskSelect.appendChild(defaultOpt);

      tasksByLot[lot].forEach(task => {
        const opt = document.createElement('option');
        opt.value = task;
        opt.textContent = task;
        taskSelect.appendChild(opt);
      });
    }

    lotSelect.addEventListener('change', refreshTasks);
    // initialisation
    refreshTasks();
  })();
</script>

<script>
  (function () {
    const form = document.querySelector('form.add-task-form');
    if (!form) return;

    const floorSelect   = form.querySelector('select[name="floor_id"]');
    const roomsDropdown = form.querySelector('[data-rooms-dropdown]');
    if (!floorSelect || !roomsDropdown) return;

    const panel = roomsDropdown.querySelector('.multi-dropdown-panel');

    function refreshRooms() {
      const floorId = floorSelect.value;

      const options = panel.querySelectorAll('.multi-dropdown-option');

      options.forEach(opt => {
        const optFloorId = opt.getAttribute('data-room-floor');
        const checkbox   = opt.querySelector('input[type="checkbox"]');

        if (!floorId || String(optFloorId) === String(floorId)) {
          opt.style.display = '';
        } else {
          opt.style.display = 'none';
          if (checkbox) checkbox.checked = false; // on décoche si on cache
        }
      });

      // force la mise à jour du texte du bouton (script multi-dropdown)
      const event = new Event('change', { bubbles: true });
      panel.dispatchEvent(event);
    }

    floorSelect.addEventListener('change', refreshRooms);
    // init
    refreshRooms();
  })();
</script>


<script>
  (function () {
    const rooms = ROOMS_DATA;
    const filtersForm = document.querySelector('form.filters');
    if (!filtersForm) return;

    const floorSelect = filtersForm.querySelector('select[name="floor"]');
    const roomSelect  = filtersForm.querySelector('select[name="room"]');

    if (!floorSelect || !roomSelect) return;

    function rebuildRoomOptions() {
      const floorId = floorSelect.value;
      const currentValue = roomSelect.value;

      // vider
      while (roomSelect.firstChild) {
        roomSelect.removeChild(roomSelect.firstChild);
      }

      // option "Toutes"
      const optAll = document.createElement('option');
      optAll.value = '';
      optAll.textContent = floorId
        ? 'Toutes les chambres de cet étage'
        : 'Toutes';
      roomSelect.appendChild(optAll);

      // filtrage des chambres
      let filtered = rooms;
      if (floorId) {
        filtered = rooms.filter(r => String(r.floor_id) === String(floorId));
      }

      filtered.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r.id;
        opt.textContent = r.floor_name + ' - ' + r.name;
        if (String(r.id) === String(currentValue)) {
          opt.selected = true;
        }
        roomSelect.appendChild(opt);
      });
    }

    // initialisation (en tenant compte des filtres déjà dans l’URL)
    rebuildRoomOptions();

    // quand l’étage change, on remet le filtre pièce à "Toutes" + reconstruit
    floorSelect.addEventListener('change', () => {
      roomSelect.value = '';
      rebuildRoomOptions();
    });

    // ----- AUTO-SUBMIT DES FILTRES -----
    ['floor', 'room', 'lot', 'status'].forEach(name => {
      const el = filtersForm.querySelector(`[name="${name}"]`);
      if (el) {
        el.addEventListener('change', () => {
          filtersForm.submit();
        });
      }
    });
  })();
</script>
<script>
  (function () {
    const DROPDOWNS = document.querySelectorAll('[data-multi-dropdown]');

    DROPDOWNS.forEach(drop => {
      const toggle = drop.querySelector('.multi-dropdown-toggle');
      const panel  = drop.querySelector('.multi-dropdown-panel');

      function getCheckboxes() {
        return panel.querySelectorAll('input[type="checkbox"]');
      }

      function updateLabel() {
        const checkboxes = Array.from(getCheckboxes());
        const selected = checkboxes
          .filter(c => c.checked)
          .map(c => c.nextElementSibling.textContent.trim());

        if (!selected.length) {
          // texte par défaut, tu peux adapter par dropdown en mettant
          // directement le texte dans le bouton dans le HTML
          toggle.textContent = 'Sélectionner...';
        } else if (selected.length === 1) {
          toggle.textContent = selected[0];
        } else {
          toggle.textContent = selected.length + ' éléments sélectionnés';
        }
      }

      toggle.addEventListener('click', (e) => {
        e.preventDefault();
        drop.classList.toggle('open');
      });

      // on écoute les changements via délégation => marche même si on
      // recrée les checkboxes (cas des pièces filtrées par étage)
      panel.addEventListener('change', (e) => {
        if (e.target.matches('input[type="checkbox"]')) {
          updateLabel();
        }
      });

      // clic à l’extérieur -> fermer
      document.addEventListener('click', (e) => {
        if (!drop.contains(e.target)) {
          drop.classList.remove('open');
        }
      });

      // init
      updateLabel();
    });
  })();
</script>

</body>
</html>

